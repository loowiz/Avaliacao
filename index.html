<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avalia√ß√£o Online</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .no-select { -webkit-user-select: none; -ms-user-select: none; user-select: none; }
        .question-card { transition: all 0.3s ease; }
        
        /* Highlight e Anima√ß√µes */
        @keyframes highlight-pulse {
            0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); border-color: #2563eb; }
            70% { box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); border-color: #2563eb; }
            100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
        }
        .highlight-card { animation: highlight-pulse 1.5s ease-out; }
        .video-thumb:hover .play-overlay { background-color: rgba(0, 0, 0, 0.3); }
        .penalty-shake { animation: shake 0.4s; background-color: #ef4444 !important; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-4px); } 40%, 80% { transform: translateX(4px); } }
        
        /* Toast & Modals */
        #custom-toast {
            visibility: hidden; min-width: 300px; background-color: #fee2e2; color: #b91c1c;
            text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 100;
            left: 50%; top: 30px; transform: translateX(-50%); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            border-left: 5px solid #ef4444; opacity: 0; transition: opacity 0.5s, top 0.5s; font-weight: bold;
        }
        #custom-toast.show { visibility: visible; opacity: 1; top: 50px; }
        @keyframes modalPop { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .modal-animate { animation: modalPop 0.2s ease-out; }
    </style>
</head>

<body class="min-h-screen py-8 px-4 sm:px-6 lg:px-8 no-select" oncontextmenu="return false;">

    <!-- TOAST -->
    <div id="custom-toast"></div>

    <!-- LOADING SPINNER -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-[999] flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-blue-600 mb-4"></div>
        <h2 class="text-xl font-bold text-gray-700">Carregando Prova...</h2>
        <p id="loading-text" class="text-sm text-gray-500 mt-2">Buscando arquivo...</p>
    </div>

    <!-- MODAL GERAL -->
    <div id="custom-modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[200] flex items-center justify-center p-4 backdrop-blur-sm">
        <div id="custom-modal-box" class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 text-center modal-animate">
            <h3 class="text-xl font-bold text-gray-900 mb-2" id="modal-title">Aviso</h3>
            <p class="text-gray-600 mb-6 text-sm leading-relaxed" id="modal-text">Mensagem.</p>
            <div class="flex justify-center gap-3" id="modal-actions"></div>
        </div>
    </div>

    <!-- MODAL DE REVIS√ÉO -->
    <div id="review-modal-overlay" class="hidden fixed inset-0 bg-gray-900 bg-opacity-95 z-[250] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6 modal-animate flex flex-col max-h-[90vh]">
            <div class="border-b pb-4 mb-4 flex justify-between items-center">
                <div>
                    <h3 class="text-2xl font-bold text-gray-900">Resumo da Avalia√ß√£o</h3>
                    <p class="text-sm text-gray-500">Verifique suas respostas antes de entregar.</p>
                </div>
                <button onclick="closeReviewModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="flex-grow overflow-y-auto mb-6">
                <div class="flex gap-4 mb-4 text-xs justify-center">
                    <div class="flex items-center gap-1"><div class="w-3 h-3 bg-green-500 rounded"></div> Respondida</div>
                    <div class="flex items-center gap-1"><div class="w-3 h-3 bg-gray-200 border border-gray-300 rounded"></div> Em branco</div>
                </div>
                <div id="review-grid" class="grid grid-cols-5 sm:grid-cols-8 gap-3"></div>
            </div>
            <div class="border-t pt-4 flex justify-between items-center bg-gray-50 -m-6 p-6 rounded-b-xl mt-0">
                <div class="text-sm">
                    <span class="font-bold text-gray-700">Total:</span> 
                    <span id="review-total-answered">0</span>/<span id="review-total-questions">0</span>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeReviewModal()" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium transition-colors">Voltar</button>
                    <button onclick="finalizeGrading()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold shadow-lg transform hover:scale-105 transition-all flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Entregar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAIS DE M√çDIA -->
    <div id="image-modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-90 z-[300] flex items-center justify-center p-4 backdrop-blur-sm" onclick="closeMediaModal()">
        <img id="expanded-image" src="" alt="Ampliada" class="max-h-[85vh] max-w-full rounded-lg shadow-2xl object-contain">
    </div>
    
    <!-- MODAL DE V√çDEO ATUALIZADO COM OP√á√ÉO EXTERNA -->
    <div id="video-modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-90 z-[300] flex items-center justify-center p-4 backdrop-blur-sm" onclick="closeMediaModal()">
        <div class="relative w-full max-w-4xl aspect-video bg-black rounded-lg shadow-2xl border-4 border-gray-800 flex flex-col" onclick="event.stopPropagation()">
            <button onclick="closeMediaModal()" class="absolute -top-12 right-0 text-white hover:text-gray-300"><svg class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            <div id="video-container" class="w-full flex-grow relative"></div>
        </div>
    </div>

    <!-- TELA DE BLOQUEIO -->
    <div id="lockout-screen" class="hidden fixed inset-0 bg-gray-100 z-[150] flex items-center justify-center p-4">
        <div class="max-w-lg w-full bg-white rounded-xl shadow-2xl p-8 text-center border-t-8 border-red-600">
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Acesso Bloqueado</h2>
            <p class="text-gray-600 mb-6">Tentativa de rein√≠cio n√£o permitida.</p>
            <p id="lock-timer" class="text-2xl font-mono font-bold text-red-600">--:--</p>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app-container" class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg relative hidden"> <!-- Inicialmente hidden at√© carregar -->

        <!-- TELA 1: BOAS-VINDAS -->
        <div id="welcome-screen" class="p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-blue-700">Avalia√ß√£o</h1>
                <p class="text-gray-600 mt-2 text-lg">Carregando configura√ß√µes...</p>
                <!-- Badge do arquivo carregado -->
                <!--<span id="exam-id-badge" class="inline-block mt-2 px-3 py-1 bg-gray-100 text-gray-500 text-xs rounded-full font-mono border">questions.js</span>-->
            </div>

            <div class="mb-8 bg-gray-50 p-6 rounded-lg border border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nome Completo</label>
                        <input type="text" id="studentName" class="mt-1 w-full p-3 border rounded-md focus:ring-blue-500" placeholder="Seu nome">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Turma</label>
                        <input type="text" id="studentClass" class="mt-1 w-full p-3 border rounded-md focus:ring-blue-500" placeholder="Sua turma">
                    </div>
                </div>
            </div>

            <!-- √ÅREA DE MATERIAL DE ESTUDO DIN√ÇMICA -->
            <div id="study-material-container" class="hidden mb-8 bg-white border border-gray-200 p-6 rounded-lg shadow-sm">
                <h3 class="text-md font-bold text-blue-800 mb-4 flex items-center gap-2">
                    üéì Material de Estudo (Revis√£o)
                </h3>
                <p class="text-sm text-gray-600 mb-4">Links recomendados para consulta pr√©via:</p>
                <div class="text-sm">
                    <ul id="study-links-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Links inseridos via JS -->
                    </ul>
                </div>
            </div>

            <div class="bg-blue-50 border border-blue-200 p-6 rounded-lg shadow-sm mb-8">
                <h3 class="text-lg font-bold text-blue-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Regras de Conduta
                </h3>
                <div class="space-y-4 text-sm text-gray-700">
                    <div class="flex items-start gap-3">
                        <div class="bg-red-100 text-red-600 p-2 rounded-full flex-shrink-0">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                        </div>
                        <div>
                            <p class="font-bold text-gray-800">N√£o saia da aba</p>
                            <p class="text-xs text-gray-500">Mudar para outra janela, aba ou minimizar o navegador contar√° como infra√ß√£o.</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start gap-3">
                        <div class="bg-red-100 text-red-600 p-2 rounded-full flex-shrink-0">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                        </div>
                        <div>
                            <p class="font-bold text-gray-800">Mantenha o foco</p>
                            <p class="text-xs text-gray-500">Clicar fora da √°rea da prova (ex: na barra de tarefas ou em outro monitor) ser√° registrado.</p>
                        </div>
                    </div>

                    <div class="flex items-start gap-3">
                        <div class="bg-red-100 text-red-600 p-2 rounded-full flex-shrink-0">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        </div>
                        <div>
                            <p class="font-bold text-gray-800">N√£o recarregue a p√°gina</p>
                            <p class="text-xs text-gray-500">Atualizar (F5) n√£o reinicia o tempo e pode bloquear seu acesso por seguran√ßa.</p>
                        </div>
                    </div>

                    <div class="flex items-start gap-3 border-t border-gray-200 pt-3 mt-2">
                        <div class="bg-orange-100 text-orange-600 p-2 rounded-full flex-shrink-0">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        </div>
                        <div>
                            <p class="font-bold text-gray-800">Limite de Infra√ß√µes: <span class="max-penalties-text text-red-600">10</span></p>
                            <p class="text-xs text-gray-500">Ao atingir o limite, a prova ser√° encerrada automaticamente e enviada como est√°.</p>
                        </div>
                    </div>
                </div>
            </div>

            <button onclick="startExam()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg shadow-lg text-lg transition transform hover:scale-[1.01]">
                INICIAR AVALIA√á√ÉO
            </button>
        </div>

        <!-- TELA 2: A PROVA -->
        <div id="exam-screen" class="hidden">
            <div class="bg-blue-600 text-white sticky top-0 z-50 shadow-md rounded-t-xl">
                <div class="px-6 py-3 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div>
                        <h1 class="text-lg font-bold truncate max-w-[200px] md:max-w-xs" id="header-title">Avalia√ß√£o</h1>
                        <p class="text-blue-100 text-xs" id="student-display">Aluno</p>
                    </div>
                    <div class="flex gap-3">
                        <div id="penalty-box" class="bg-red-800 px-3 py-1 rounded text-center">
                            <p class="text-[9px] text-red-200 uppercase">Penalidades</p>
                            <div class="font-mono font-bold"><span id="penalty-display">0</span>/<span class="max-penalties-text">10</span></div>
                        </div>
                        <div class="bg-blue-800 px-3 py-1 rounded text-center min-w-[80px]">
                            <p class="text-[9px] text-blue-200 uppercase">Tempo</p>
                            <div id="timer-display" class="font-mono font-bold">00:00</div>
                        </div>
                    </div>
                </div>
                <div class="bg-blue-800 h-1 w-full relative">
                    <div id="progress-bar" class="bg-green-400 h-full w-0 transition-all duration-500 ease-out"></div>
                </div>
                <div class="bg-blue-700 px-6 py-1 text-xs text-blue-100 flex justify-between">
                    <span>Progresso: <span id="progress-text-count">0</span> de <span id="total-questions-count">0</span></span>
                    <span id="progress-percent">0%</span>
                </div>
            </div>
            <div id="quiz-container" class="p-6 space-y-8 bg-gray-50 min-h-[500px] pb-24"></div>
            <div class="p-6 bg-white border-t border-gray-200 flex justify-end gap-4 rounded-b-xl sticky bottom-0 z-40 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                <button onclick="openReviewModal()" id="btn-review" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg flex items-center gap-2 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg> Revisar e Finalizar
                </button>
                <button onclick="generatePDF()" id="btn-pdf" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg flex items-center gap-2">
                    üìÑ Baixar Comprovante
                </button>
            </div>
            <div id="result-area" class="hidden p-8 bg-white text-center border-t border-gray-200">
                <div class="inline-block p-4 rounded-full bg-blue-50 mb-4">
                    <h3 class="text-4xl font-bold text-blue-600" id="score-display">--</h3>
                </div>
                <p class="text-gray-500 mb-6">Nota Final (/100)</p>
                <div class="bg-yellow-50 p-4 rounded border border-yellow-200 inline-block text-left text-sm max-w-md">
                    <strong>Pr√≥ximo passo:</strong> Clique no bot√£o verde "Baixar Comprovante" e envie o arquivo PDF no Google Classroom.
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO E CONSTANTES ---
        const _s = "S3cr3t_K3y_@!#_SENAI_2025";
        let _decryptedKey = "";
        
        let CONFIG = {
            title: "Avalia√ß√£o",
            maxPenalties: 10,
            timeLimitMinutes: 30,
            lockoutDurationMinutes: 60,
            questionsQty: 20,
            showAnswers: true,
            difficultyDistribution: { easy: 30, medium: 40, hard: 30 },
            studyLinks: [] 
        };

        // Vari√°veis de Estado
        let MAX_PENALTIES, TIME_LIMIT_SECONDS, SESSION_LOCK_TIME_MS, STORAGE_KEY;
        let currentQuestions = [], userAnswers = {}, isExamStarted = false, isLocked = false, isFinished = false;
        let penaltyCount = 0, timerInterval, timeElapsed = 0;
        let currentExamId = "questions";
        
        // --- CONTROLE DE SEGURAN√áA EXTERNA ---
        let isSafeExternalLink = false; // Flag para permitir sa√≠da segura

        // --- SISTEMA DE CARREGAMENTO DIN√ÇMICO ---
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            let examId = urlParams.get('id');

            if (examId) examId = examId.replace(/[^a-zA-Z0-9_-]/g, "");
            if (!examId) examId = "questions";
            
            currentExamId = examId;
            document.getElementById('loading-text').textContent = `Carregando: ${examId}.js ...`;

            const script = document.createElement('script');
            script.src = `${examId}.js`;
            
            script.onload = function() {
                console.log(`Prova ${examId}.js carregada.`);
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('main-app-container').classList.remove('hidden');
                initApp();
            };

            script.onerror = function() {
                document.getElementById('loading-overlay').innerHTML = `
                    <div class="text-center p-8">
                        <svg class="h-16 w-16 text-red-500 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <h2 class="text-xl font-bold text-gray-800">Prova n√£o encontrada!</h2>
                        <p class="text-gray-600 mt-2">A prova <b>${examId}</b> n√£o existe.</p>
                        <p class="text-sm text-gray-400 mt-4">Verifique o link ou contate seu professor.</p>
                    </div>
                `;
            };

            document.head.appendChild(script);
        };

        function initApp() {
            if (typeof examConfig !== 'undefined') CONFIG = { ...CONFIG, ...examConfig };
            // Garante que existe distribui√ß√£o mesmo em arquivos antigos
            if (!CONFIG.difficultyDistribution) CONFIG.difficultyDistribution = { easy: 30, medium: 40, hard: 30 };

            MAX_PENALTIES = CONFIG.maxPenalties;
            TIME_LIMIT_SECONDS = CONFIG.timeLimitMinutes * 60;
            SESSION_LOCK_TIME_MS = CONFIG.lockoutDurationMinutes * 60 * 1000;
            STORAGE_KEY = `lock_${currentExamId}`;

            if (typeof _k !== 'undefined') _decryptedKey = /^[abcd]+$/.test(_k) ? _k : _d(_k);

            document.querySelector('#welcome-screen h1').textContent = CONFIG.title;
            document.getElementById('header-title').textContent = CONFIG.title;
            document.querySelector('#welcome-screen p.text-gray-600').textContent = 
                `Tempo: ${CONFIG.timeLimitMinutes} min | Quest√µes: ${CONFIG.questionsQty}`;
            
            document.getElementById('exam-id-badge').textContent = `${currentExamId}`;

            document.querySelectorAll('.max-penalties-text').forEach(el => el.textContent = MAX_PENALTIES);

            // --- RENDERIZAR LINKS DE ESTUDO DIN√ÇMICOS ---
            if (CONFIG.studyLinks && Array.isArray(CONFIG.studyLinks) && CONFIG.studyLinks.length > 0) {
                const list = document.getElementById('study-links-list');
                list.innerHTML = '';
                CONFIG.studyLinks.forEach(link => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="${link.url}" target="_blank" class="text-blue-600 hover:underline flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                        ${link.label}
                    </a>`;
                    list.appendChild(li);
                });
                document.getElementById('study-material-container').classList.remove('hidden');
            }
            
            checkSessionLock();
        }

        // --- UTILS ---
        function _d(encoded) {
            try {
                let text = atob(encoded);
                let result = "";
                for (let i = 0; i < text.length; i++) {
                    result += String.fromCharCode(text.charCodeAt(i) ^ _s.charCodeAt(i % _s.length));
                }
                return result;
            } catch(e) { return encoded; }
        }

        function getYoutubeId(url) {
            if (!url) return null;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=|shorts\/)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- L√ìGICA DE PROVA ---
        function startExam() {
            if (typeof fullQuestionBank === 'undefined') {
                showToast("Erro: Banco de quest√µes n√£o carregado.");
                return;
            }

            const name = document.getElementById('studentName').value.trim();
            const turma = document.getElementById('studentClass').value.trim();

            if (!name || !turma) {
                showToast("Preencha seu Nome e Turma.");
                return;
            }

            showModal("Confirmar In√≠cio", "O tempo come√ßar√° agora.\nN√£o saia da tela cheia ou mude de aba.", () => {
                setSessionLock();
                document.getElementById('student-display').textContent = `${name} (${turma})`;
                document.getElementById('welcome-screen').classList.add('hidden');
                document.getElementById('exam-screen').classList.remove('hidden');
                document.getElementById('exam-screen').classList.add('block');
                isExamStarted = true;
                generateQuiz();
                startTimer();
                window.scrollTo(0, 0);
            }, true);
        }

        function generateQuiz() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = '';
            userAnswers = {};

            // 1. Defini√ß√£o de cotas
            const totalQty = CONFIG.questionsQty;
            const dist = CONFIG.difficultyDistribution;
            
            let easyTarget = Math.round(totalQty * (dist.easy / 100));
            let mediumTarget = Math.round(totalQty * (dist.medium / 100));
            let hardTarget = totalQty - easyTarget - mediumTarget;

            if (hardTarget < 0) { hardTarget = 0; mediumTarget = totalQty - easyTarget; }

            // 2. Separa√ß√£o por Nichos (Pools)
            const pools = {
                easy: fullQuestionBank.filter(q => q.difficulty === 'easy'),
                medium: fullQuestionBank.filter(q => !q.difficulty || q.difficulty === 'medium'),
                hard: fullQuestionBank.filter(q => q.difficulty === 'hard')
            };

            // 3. Embaralha
            shuffleArray(pools.easy);
            shuffleArray(pools.medium);
            shuffleArray(pools.hard);

            // 4. Sele√ß√£o das quest√µes
            let selectedList = [];
            const take = (pool, count) => {
                if (count <= 0) return [];
                return pool.splice(0, count);
            };

            selectedList.push(...take(pools.easy, easyTarget));
            selectedList.push(...take(pools.medium, mediumTarget));
            selectedList.push(...take(pools.hard, hardTarget));

            // 5. Fallback
            if (selectedList.length < totalQty) {
                const missingCount = totalQty - selectedList.length;
                const leftovers = [...pools.easy, ...pools.medium, ...pools.hard];
                shuffleArray(leftovers);
                selectedList.push(...take(leftovers, missingCount));
            }

            currentQuestions = shuffleArray(selectedList);
            document.getElementById('total-questions-count').textContent = currentQuestions.length;

            currentQuestions.forEach((qObj, index) => {
                const div = document.createElement('div');
                div.id = `q-card-${index}`;
                div.className = 'bg-white p-6 rounded-lg border shadow-sm question-card scroll-mt-32';

                let mediaHtml = '';
                if (qObj.video) {
                    const vidId = getYoutubeId(qObj.video);
                    if (vidId) {
                        mediaHtml = `
                        <div class="mb-4 flex justify-center group">
                            <div class="relative cursor-pointer video-thumb rounded-lg overflow-hidden shadow-md border w-full max-w-md aspect-video bg-black" onclick="openVideoModal('${vidId}')">
                                <img src="https://img.youtube.com/vi/${vidId}/mqdefault.jpg" class="w-full h-full object-cover opacity-80" alt="Video">
                                <div class="absolute inset-0 flex items-center justify-center"><div class="bg-red-600 text-white rounded-full p-3"><svg class="w-6 h-6 fill-current" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div></div>
                            </div>
                        </div>`;
                    }
                } else if (qObj.image) {
                    mediaHtml = `<div class="mb-4 flex justify-center"><img src="${qObj.image}" class="max-h-60 rounded border cursor-pointer hover:opacity-90" onclick="openImageModal('${qObj.image}')"></div>`;
                }

                const mixedOptions = qObj.options.map((opt, i) => ({ text: opt, originalIdx: i }));
                shuffleArray(mixedOptions);

                let opts = '';
                mixedOptions.forEach((optObj) => {
                    const safeOpt = optObj.text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    opts += `
                    <label class="flex items-start space-x-3 p-3 rounded-lg border border-transparent hover:bg-blue-50 cursor-pointer transition-colors">
                        <input type="radio" name="q${index}" value="${optObj.originalIdx}" class="mt-1 h-5 w-5 text-blue-600 focus:ring-blue-500" onchange="saveAnswer(${index}, ${optObj.originalIdx})">
                        <span class="text-gray-700 leading-snug">${safeOpt}</span>
                    </label>`;
                });

                div.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <h3 class="text-lg font-bold text-gray-800"><span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-sm mr-2">Q${index + 1}</span> ${qObj.q}</h3>
                </div>
                ${mediaHtml}
                <div class="space-y-1">${opts}</div>
                <div id="feedback-${index}" class="mt-3 font-bold hidden p-2 rounded text-center"></div>
                `;
                container.appendChild(div);
            });
            renderMath();
            updateProgress();
        }

        function saveAnswer(questionIdx, answerValue) {
            userAnswers[questionIdx] = answerValue;
            const card = document.getElementById(`q-card-${questionIdx}`);
            card.querySelectorAll('label').forEach(l => l.classList.remove('bg-blue-100', 'border-blue-200'));
            const selectedRadio = card.querySelector(`input[value="${answerValue}"]`);
            if(selectedRadio) selectedRadio.closest('label').classList.add('bg-blue-100', 'border-blue-200');
            updateProgress();
        }

        function updateProgress() {
            const total = currentQuestions.length;
            const answered = Object.keys(userAnswers).length;
            const percent = Math.round((answered / total) * 100);
            const bar = document.getElementById('progress-bar');
            bar.style.width = `${percent}%`;
            if(percent < 50) bar.classList.replace('bg-green-500', 'bg-yellow-400');
            else bar.classList.replace('bg-yellow-400', 'bg-green-500');
            document.getElementById('progress-text-count').textContent = answered;
            document.getElementById('progress-percent').textContent = `${percent}%`;
        }

        function openReviewModal() {
            const grid = document.getElementById('review-grid');
            grid.innerHTML = '';
            let answeredCount = 0;
            currentQuestions.forEach((_, index) => {
                const isAnswered = userAnswers.hasOwnProperty(index);
                if (isAnswered) answeredCount++;
                const btn = document.createElement('button');
                btn.className = `p-2 rounded font-bold text-sm border transition-all transform hover:scale-105 ${
                    isAnswered ? 'bg-green-100 border-green-300 text-green-800 hover:bg-green-200' : 'bg-gray-100 border-gray-300 text-gray-500 hover:bg-gray-200'
                }`;
                btn.textContent = index + 1;
                btn.onclick = () => jumpToQuestion(index);
                grid.appendChild(btn);
            });
            document.getElementById('review-total-answered').textContent = answeredCount;
            document.getElementById('review-total-questions').textContent = currentQuestions.length;
            document.getElementById('review-modal-overlay').classList.remove('hidden');
        }

        function closeReviewModal() { document.getElementById('review-modal-overlay').classList.add('hidden'); }
        function jumpToQuestion(index) {
            closeReviewModal();
            const card = document.getElementById(`q-card-${index}`);
            if (card) {
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                card.classList.remove('highlight-card');
                void card.offsetWidth; 
                card.classList.add('highlight-card');
            }
        }

        function finalizeGrading() {
            closeReviewModal();
            isFinished = true; isLocked = true; clearInterval(timerInterval);
            window.onbeforeunload = null; localStorage.removeItem(STORAGE_KEY);
            let score = 0; const pointsPerQuestion = 100 / currentQuestions.length;
            currentQuestions.forEach((q, i) => {
                const correct = getCorrectAnswerIndex(q.id);
                const feedback = document.getElementById(`feedback-${i}`);
                feedback.classList.remove('hidden');
                document.getElementsByName(`q${i}`).forEach(inp => inp.disabled = true);
                if (userAnswers[i] == correct) {
                    score += pointsPerQuestion;
                    feedback.innerHTML = "‚úÖ Resposta Correta";
                    feedback.classList.add('bg-green-100', 'text-green-700');
                } else {
                    feedback.innerHTML = "‚ùå Resposta Incorreta";
                    feedback.classList.add('bg-red-100', 'text-red-700');
                    if (CONFIG.showAnswers) {
                        const correctRadio = document.querySelector(`input[name="q${i}"][value="${correct}"]`);
                        if(correctRadio) {
                            const label = correctRadio.closest('label');
                            label.classList.add('ring-2', 'ring-green-500', 'bg-green-50');
                            label.innerHTML += `<span class="ml-auto text-xs font-bold text-green-700 bg-green-200 px-2 py-1 rounded">Correta</span>`;
                        }
                    }
                }
            });
            document.getElementById('score-display').textContent = Math.round(score * 10) / 10;
            document.getElementById('btn-review').classList.add('hidden');
            document.getElementById('result-area').classList.remove('hidden');
            document.getElementById('btn-pdf').classList.remove('hidden');
            setTimeout(() => document.getElementById('result-area').scrollIntoView({ behavior: 'smooth' }), 500);
        }

        function getCorrectAnswerIndex(qid) {
            if (!_decryptedKey && typeof _k !== 'undefined') _decryptedKey = /^[abcd]+$/.test(_k) ? _k : _d(_k);
            if (!_decryptedKey) return 0;
            return _decryptedKey.charCodeAt(qid) - 97;
        }

        function startTimer() {
            const display = document.getElementById('timer-display');
            timerInterval = setInterval(() => {
                if (isLocked) return clearInterval(timerInterval);
                timeElapsed++;
                const m = Math.floor(timeElapsed / 60).toString().padStart(2, '0');
                const s = (timeElapsed % 60).toString().padStart(2, '0');
                display.textContent = `${m}:${s}`;
                if (timeElapsed >= TIME_LIMIT_SECONDS) forceFinish("Tempo esgotado!");
            }, 1000);
        }

        function addPenalty(reason) {
            // VERIFICA SE EST√Å EM MODO SEGURO (LINK EXTERNO ATIVO)
            if (isSafeExternalLink) return; 

            if (!isExamStarted || isLocked || isFinished) return;
            penaltyCount++;
            document.getElementById('penalty-display').textContent = penaltyCount;
            const box = document.getElementById('penalty-box');
            box.classList.add('penalty-shake');
            setTimeout(() => box.classList.remove('penalty-shake'), 500);
            if (penaltyCount >= MAX_PENALTIES) forceFinish("Limite de penalidades atingido!");
            else showToast(`‚ö†Ô∏è PENALIDADE (${penaltyCount}/${MAX_PENALTIES}): ${reason}`);
        }

        function forceFinish(reason) {
            isLocked = true; clearInterval(timerInterval);
            showModal("Prova Encerrada", `${reason}\nO sistema finalizar√° sua avalia√ß√£o agora.`, () => finalizeGrading());
        }

        // --- SISTEMA ANTI-TRAPA√áA ---
        setInterval(() => {
            if (isExamStarted && !isLocked && !isFinished && !isSafeExternalLink) { // Ignora se estiver no youtube
                const t0 = Date.now();
                debugger; 
                if (Date.now() - t0 > 100) {
                    addPenalty("Inspector/DevTools aberto.");
                }
            }
        }, 4000);

        // --- DETEC√á√ÉO DE MUDAN√áA DE ABA ---
        document.addEventListener("visibilitychange", () => { 
            // S√≥ aplica penalidade se N√ÉO for um link seguro permitido
            if (document.hidden && isExamStarted && !isLocked && !isFinished && !isSafeExternalLink) {
                addPenalty("Saiu da aba."); 
            }
        });

        // --- DETEC√á√ÉO DE PERDA DE FOCO ---
        window.addEventListener("blur", () => {
            if (isExamStarted && !isLocked && !isFinished && !isSafeExternalLink) {
                const active = document.activeElement;
                if (active && active.tagName === 'IFRAME') return;
                const modals = ['custom-modal-overlay', 'review-modal-overlay', 'image-modal-overlay', 'video-modal-overlay'];
                if(!modals.some(id => !document.getElementById(id).classList.contains('hidden'))) {
                    addPenalty("Janela perdeu foco.");
                }
            }
        });

        // Retorno de Foco: Reativa a seguran√ßa
        window.addEventListener("focus", () => {
            if (isSafeExternalLink) {
                // D√° um pequeno delay antes de reativar a seguran√ßa para evitar penalidade imediata
                setTimeout(() => {
                    isSafeExternalLink = false;
                    console.log("Seguran√ßa reativada.");
                }, 1000);
            }
        });

        window.onbeforeunload = function () { if (isExamStarted && !isFinished) return "Sair agora bloquear√° seu acesso."; };
        document.addEventListener('copy', (e) => { if (isExamStarted) { e.preventDefault(); addPenalty("C√≥pia bloqueada"); } });
        document.addEventListener('contextmenu', (e) => { e.preventDefault(); return false; });
        document.addEventListener('keydown', (e) => { if (e.key === "F12" || (e.ctrlKey && (e.key === "u" || e.key === "p"))) { e.preventDefault(); addPenalty("Tecla proibida"); } });

        function setSessionLock() { localStorage.setItem(STORAGE_KEY, JSON.stringify({ timestamp: Date.now() })); }
        function checkSessionLock() {
            const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
            if (data) {
                const passed = Date.now() - data.timestamp;
                if (passed < SESSION_LOCK_TIME_MS) {
                    document.getElementById('main-app-container').classList.add('hidden');
                    document.getElementById('lockout-screen').classList.remove('hidden');
                    const unlockTime = data.timestamp + SESSION_LOCK_TIME_MS;
                    setInterval(() => {
                        const rem = unlockTime - Date.now();
                        if (rem <= 0) { localStorage.removeItem(STORAGE_KEY); location.reload(); }
                        else {
                            const m = Math.floor(rem / 60000).toString().padStart(2,'0');
                            const s = Math.floor((rem % 60000) / 1000).toString().padStart(2,'0');
                            document.getElementById('lock-timer').textContent = `${m}:${s}`;
                        }
                    }, 1000);
                } else { localStorage.removeItem(STORAGE_KEY); }
            }
        }

        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const name = document.getElementById('studentName').value;
            const turma = document.getElementById('studentClass').value;
            const score = document.getElementById('score-display').textContent;
            const now = new Date();
            const raw = `${name}${score}${timeElapsed}${penaltyCount}${now.getTime()}${currentExamId}`;
            let hash = 0; for(let i=0; i<raw.length; i++) hash = ((hash << 5) - hash) + raw.charCodeAt(i) | 0;
            const authCode = "AUTH-" + Math.abs(hash).toString(16).toUpperCase().padStart(8, '0');

            doc.setFillColor(37, 99, 235); doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255); doc.setFontSize(22); doc.text("Comprovante de Avalia√ß√£o", 105, 25, { align: "center" });
            
            doc.setTextColor(0, 0, 0); doc.setFontSize(12);
            doc.text(`Aluno: ${name}`, 20, 60); doc.text(`Turma: ${turma}`, 20, 70);
            doc.text(`Data: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`, 20, 80);
            doc.text(`Prova ID: ${currentExamId}`, 20, 90);

            doc.setFontSize(16); doc.text(`Nota Final: ${score} / 100`, 20, 110);
            doc.setFontSize(12); doc.text(`Tempo de Prova: ${document.getElementById('timer-display').textContent}`, 20, 120);
            
            if (penaltyCount > 0) { doc.setTextColor(220, 38, 38); doc.text(`Penalidades: ${penaltyCount}`, 20, 130); } 
            else { doc.setTextColor(22, 163, 74); doc.text("Conduta: Limpa (Sem infra√ß√µes)", 20, 130); }

            doc.setTextColor(150, 150, 150); doc.setFontSize(10);
            doc.text("C√≥digo de Autentica√ß√£o:", 105, 160, { align: "center" });
            doc.setFont("courier", "bold"); doc.setFontSize(14); doc.setTextColor(0, 0, 0);
            doc.text(authCode, 105, 170, { align: "center" });
            doc.save(`Relatorio_${name.replace(/\s+/g, '_')}_${currentExamId}.pdf`);
        }

        // --- FUN√á√ÉO PARA ABRIR YOUTUBE SEGURO ---
        function openSafeYouTube(vidId) {
            isSafeExternalLink = true; // Ativa flag de seguran√ßa
            window.open(`https://www.youtube.com/watch?v=${vidId}`, '_blank');
        }

        function showModal(title, msg, onConfirm, isConfirm = false) {
            const overlay = document.getElementById('custom-modal-overlay');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-text').innerText = msg;
            const actions = document.getElementById('modal-actions'); actions.innerHTML = '';
            const btn = document.createElement('button');
            btn.className = "bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700";
            btn.textContent = isConfirm ? "Confirmar" : "OK";
            btn.onclick = () => { overlay.classList.add('hidden'); if(onConfirm) onConfirm(); };
            actions.appendChild(btn);
            if(isConfirm) {
                const cancel = document.createElement('button');
                cancel.className = "bg-gray-200 text-gray-700 px-6 py-2 rounded font-bold hover:bg-gray-300";
                cancel.textContent = "Cancelar";
                cancel.onclick = () => overlay.classList.add('hidden');
                actions.appendChild(cancel);
            }
            overlay.classList.remove('hidden');
        }
        function showToast(msg) { const t = document.getElementById("custom-toast"); t.textContent = msg; t.className = "show"; setTimeout(() => t.className = t.className.replace("show", ""), 3000); }
        function renderMath() { if (window.renderMathInElement) { renderMathInElement(document.getElementById('quiz-container'), { delimiters: [ { left: '$$', right: '$$', display: true }, { left: '$', right: '$', display: false }, { left: '\\(', right: '\\)', display: false }, { left: '\\[', right: '\\]', display: true } ], throwOnError: false }); } }
        function openImageModal(src) { document.getElementById('expanded-image').src = src; document.getElementById('image-modal-overlay').classList.remove('hidden'); }
        
        // MODAL DE VIDEO ATUALIZADO
        function openVideoModal(vidId) { 
            const container = document.getElementById('video-container');
            container.innerHTML = `
                <div class="flex flex-col h-full bg-black rounded-lg overflow-hidden">
                    <div class="flex-grow">
                        <iframe class="w-full h-full" src="https://www.youtube.com/embed/${vidId}?autoplay=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                    </div>
                    <div class="bg-gray-900 p-3 text-center border-t border-gray-800">
                        <p class="text-gray-400 text-xs mb-2">O v√≠deo n√£o carregou? (Erro 153 ou tela preta?)</p>
                        <button onclick="openSafeYouTube('${vidId}')" class="bg-red-600 hover:bg-red-700 text-white text-sm px-4 py-2 rounded flex items-center justify-center gap-2 mx-auto transition-colors font-bold shadow-lg">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                            Assistir no YouTube (Sem Penalidade)
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('video-modal-overlay').classList.remove('hidden'); 
        }
        
        function closeMediaModal() { document.getElementById('image-modal-overlay').classList.add('hidden'); document.getElementById('video-modal-overlay').classList.add('hidden'); document.getElementById('video-container').innerHTML = ""; }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avalia√ß√£o de Recupera√ß√£o: UC Linguagem de Programa√ß√£o</title>
    <!-- Tailwind CSS (Estilo Visual) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF (Gerador de PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- IMPORTANTE: Carrega o banco de quest√µes externo -->
    <script src="questions.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        
        /* Estilos Nativos (Backup) */
        .hidden { display: none !important; }
        .block { display: block; }
        .text-center { text-align: center; }

        /* Prote√ß√£o Anti-C√≥pia */
        .no-select {
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .question-card { transition: all 0.3s ease; }
        .question-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        /* Notifica√ß√£o Flutuante (Toast) */
        #custom-toast {
            visibility: hidden; 
            min-width: 300px;
            background-color: #fee2e2;
            color: #b91c1c;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            top: 30px;
            transform: translateX(-50%);
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            border-left: 5px solid #ef4444;
            opacity: 0;
            transition: opacity 0.5s, top 0.5s;
            font-weight: bold;
        }
        #custom-toast.show { visibility: visible; opacity: 1; top: 50px; }

        /* Modal Personalizado */
        @keyframes modalPop {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .modal-animate { animation: modalPop 0.2s ease-out; }

        /* Anima√ß√µes */
        @keyframes pulse-red {
            0% { color: white; }
            50% { color: #ffcccc; }
            100% { color: white; }
        }
        .timer-warning { animation: pulse-red 1s infinite; font-weight: bold; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }
        .penalty-shake { animation: shake 0.4s; background-color: #ef4444 !important; }
    </style>
</head>
<body class="min-h-screen py-8 px-4 sm:px-6 lg:px-8 no-select" oncontextmenu="return false;">

    <!-- TOAST -->
    <div id="custom-toast"></div>

    <!-- MODAL (Avisos) -->
    <div id="custom-modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[200] flex items-center justify-center p-4 backdrop-blur-sm">
        <div id="custom-modal-box" class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 text-center modal-animate">
            <div class="mb-4">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                    <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-gray-900" id="modal-title">Aviso</h3>
                <p class="text-gray-600 mt-2 text-sm leading-relaxed" id="modal-text">Mensagem.</p>
            </div>
            <div class="flex justify-center gap-3" id="modal-actions"></div>
        </div>
    </div>

    <!-- TELA DE BLOQUEIO (LOCKOUT) -->
    <div id="lockout-screen" class="hidden fixed inset-0 bg-gray-100 z-[150] flex items-center justify-center p-4">
        <div class="max-w-lg w-full bg-white rounded-xl shadow-2xl overflow-hidden border-t-8 border-red-600">
            <div class="p-8 text-center">
                <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 mb-6">
                    <svg class="h-8 w-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Acesso Bloqueado</h2>
                <p class="text-gray-600 mb-6">
                    Uma tentativa de avalia√ß√£o j√° foi iniciada neste navegador recentemente. 
                    Para garantir a integridade da prova, o rein√≠cio imediato n√£o √© permitido.
                </p>
                <div class="bg-red-50 p-4 rounded-lg border border-red-100">
                    <p class="text-sm text-red-800 font-medium">Voc√™ poder√° tentar novamente em:</p>
                    <p id="lock-timer" class="text-2xl font-mono font-bold text-red-600 mt-1">--:--</p>
                </div>
                <p class="text-xs text-gray-400 mt-6">Se houve um erro t√©cnico grave, contate o professor.</p>
            </div>
        </div>
    </div>

    <div id="main-app-container" class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg relative">
        
        <!-- TELA 1: BOAS-VINDAS -->
        <div id="welcome-screen" class="p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-blue-700">Avalia√ß√£o de Recupera√ß√£o</h1>
                <p class="text-gray-600 mt-2 text-lg">Situa√ß√£o de Aprendizagem 3 - Arduino</p>
            </div>

            <!-- QUADRO DE BOAS-VINDAS E INSTRU√á√ïES -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-600 p-6 mb-8 rounded-lg shadow-sm">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <span class="text-3xl">üëã</span>
                    </div>
                    <div class="ml-4">
                        <h2 class="text-xl font-bold text-blue-900 mb-2">Bem-vindo(a) √† sua Avalia√ß√£o!</h2>
                        <p class="text-gray-700 mb-4 leading-relaxed">
                            Esta atividade verifica seus conhecimentos sobre os projetos pr√°ticos de Arduino realizados em aula.
                            Siga o roteiro abaixo para realizar a prova com tranquilidade:
                        </p>
                        <ol class="list-decimal list-inside space-y-2 text-sm text-gray-800 font-medium bg-white p-4 rounded border border-blue-100">
                            <li><span class="text-blue-600 font-bold">Identifica√ß√£o:</span> Preencha seu Nome e Turma no campo abaixo.</li>
                            <li><span class="text-blue-600 font-bold">Revis√£o:</span> Se precisar, use os links de "Material de Estudo" antes de come√ßar.</li>
                            <li><span class="text-blue-600 font-bold">Aten√ß√£o:</span> Ao clicar em <strong>INICIAR</strong>, o tempo de 30 minutos come√ßar√° a contar.</li>
                            <li><span class="text-blue-600 font-bold">Seguran√ßa:</span> N√£o saia desta tela. O sistema monitora mudan√ßas de aba.</li>
                            <li><span class="text-blue-600 font-bold">Entrega:</span> Ao terminar, baixe o PDF gerado e envie no Google Classroom.</li>
                        </ol>
                    </div>
                </div>
            </div>

            <div class="mb-8 bg-gray-50 p-6 rounded-lg border border-gray-200 shadow-sm">
                <h3 class="text-md font-bold text-gray-700 mb-4 uppercase tracking-wide border-b pb-2">1. Dados do Aluno</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nome Completo</label>
                        <input type="text" id="studentName" class="mt-1 w-full p-3 border rounded-md focus:ring-blue-500" placeholder="Digite seu nome...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Turma</label>
                        <input type="text" id="studentClass" class="mt-1 w-full p-3 border rounded-md focus:ring-blue-500" placeholder="Ex: 1¬∫ Mecatr√¥nica">
                    </div>
                </div>
            </div>

            <div class="mb-8 bg-white border border-gray-200 p-6 rounded-lg shadow-sm">
                <h3 class="text-md font-bold text-blue-800 mb-4 flex items-center gap-2">
                    üéì Material de Estudo (Revis√£o)
                </h3>
                <p class="text-sm text-gray-600 mb-4">Links oficiais das esta√ß√µes para consulta pr√©via:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                    <div>
                        <h4 class="font-bold text-gray-700 mb-2">L√≥gica e Programa√ß√£o</h4>
                        <ul class="list-disc pl-4 space-y-1 text-blue-600">
                            <li><a href="https://youtu.be/ZaGx0ll0pnU" target="_blank" class="hover:underline">Estruturas Condicionais (If/Else)</a></li>
                            <li><a href="https://youtu.be/MeAA0oX6LyE" target="_blank" class="hover:underline">Entradas Digitais</a></li>
                            <li><a href="https://youtu.be/hRtF2UCNatM" target="_blank" class="hover:underline">Sa√≠das Digitais</a></li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-700 mb-2">Componentes</h4>
                        <ul class="list-disc pl-4 space-y-1 text-blue-600">
                            <li><a href="https://youtu.be/MQlRQaOtkoM" target="_blank" class="hover:underline">Teclado Matricial</a></li>
                            <li><a href="https://youtu.be/0yxg3Z_Gc60" target="_blank" class="hover:underline">Display LCD</a></li>
                            <li><a href="https://projecthub.arduino.cc/arcaegecengiz/using-dht11-12f621" target="_blank" class="hover:underline">Sensor DHT11</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="bg-yellow-50 border border-yellow-200 p-5 rounded-lg shadow-sm mb-8">
                <h3 class="text-md font-bold text-red-700 mb-2">‚ö†Ô∏è Sistema Anti-Fraude Ativo</h3>
                <ul class="text-sm text-gray-700 list-disc pl-5">
                    <li><strong>Tentativa √önica:</strong> Ao iniciar, voc√™ ter√° 1 hora de bloqueio para reiniciar a p√°gina. N√£o atualize (F5)!</li>
                    <li><strong>Foco da Janela:</strong> Clicar fora da prova ou em outro monitor gera penalidade.</li>
                    <li><strong>Bloqueio de C√≥pia:</strong> A sele√ß√£o de texto e atalhos est√£o desativados.</li>
                    <li><strong><span class="max-penalties-text">10</span> Penalidades = BLOQUEIO:</strong> A prova ser√° encerrada automaticamente.</li>
                </ul>
            </div>

            <button onclick="startExam()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg shadow-lg text-lg transition transform hover:scale-[1.01]">
                üöÄ LI AS REGRAS E QUERO INICIAR AVALIA√á√ÉO
            </button>
        </div>

        <!-- TELA 2: A PROVA -->
        <div id="exam-screen" class="hidden">
            
            <div class="bg-blue-600 px-6 py-4 text-white flex flex-col md:flex-row justify-between items-center sticky top-0 z-50 shadow-md rounded-t-xl gap-4">
                <div>
                    <h1 class="text-lg md:text-xl font-bold">Avalia√ß√£o em Andamento</h1>
                    <p class="text-blue-100 text-xs mt-1" id="student-display">Aluno: ...</p>
                </div>
                <div class="flex gap-4">
                    <div id="penalty-box" class="bg-red-800 px-3 py-2 rounded-lg text-center min-w-[100px]">
                        <p class="text-[10px] text-red-200 uppercase">Penalidades</p>
                        <div class="text-lg font-mono font-bold"><span id="penalty-display">0</span>/<span class="max-penalties-text">10</span></div>
                    </div>
                    <div class="bg-blue-800 px-3 py-2 rounded-lg text-center min-w-[100px]">
                        <p class="text-[10px] text-blue-200 uppercase">Tempo</p>
                        <div id="timer-display" class="text-lg font-mono font-bold">00:00</div>
                    </div>
                </div>
            </div>

            <div id="quiz-container" class="p-6 space-y-6 bg-gray-50 min-h-[500px]"></div>

            <div class="p-6 bg-white border-t border-gray-200 flex justify-end gap-4 rounded-b-xl">
                <button onclick="finishQuiz()" id="btn-finish" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow">
                    Finalizar e Ver Nota
                </button>
                <button onclick="generatePDF()" id="btn-pdf" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow flex items-center gap-2">
                    üìÑ Baixar Comprovante
                </button>
            </div>
            
            <div id="result-area" class="hidden p-6 bg-yellow-50 text-center border-t border-yellow-200">
                <h3 class="text-2xl font-bold text-gray-800">Nota: <span id="score-display" class="text-blue-600"></span>/100</h3>
            </div>
        </div>
    </div>

<script>
    // --- CONFIGURA√á√ÉO GLOBAL ---
    const MAX_PENALTIES = 10;
    const TIME_LIMIT_SECONDS = 30 * 60; // 30 minutos de prova
    const SESSION_LOCK_TIME_MS = 60 * 60 * 1000; // 1 hora de bloqueio ap√≥s iniciar
    const STORAGE_KEY = 'arduino_quiz_lock'; // Chave para salvar no navegador

    let currentQuestions = [];
    let userAnswers = {};
    let isExamStarted = false;
    let isLocked = false;
    let penaltyCount = 0;
    let timerInterval;
    let timeElapsed = 0;

    // Inicializa√ß√£o ao carregar
    window.onload = function() {
        // Atualiza textos da interface
        document.querySelectorAll('.max-penalties-text').forEach(el => {
            el.textContent = MAX_PENALTIES;
        });
        
        // Verifica se h√° bloqueio de sess√£o
        checkSessionLock();
    };

    // --- L√ìGICA DE BLOQUEIO DE SESS√ÉO ---
    function checkSessionLock() {
        const storedData = localStorage.getItem(STORAGE_KEY);
        if (storedData) {
            const session = JSON.parse(storedData);
            const now = Date.now();
            const timePassed = now - session.timestamp;

            if (timePassed < SESSION_LOCK_TIME_MS) {
                // Bloqueia a tela
                document.getElementById('main-app-container').classList.add('hidden');
                document.getElementById('lockout-screen').classList.remove('hidden');
                
                // Inicia contagem regressiva para desbloqueio
                const unlockTime = session.timestamp + SESSION_LOCK_TIME_MS;
                
                setInterval(() => {
                    const remaining = unlockTime - Date.now();
                    if (remaining <= 0) {
                        localStorage.removeItem(STORAGE_KEY);
                        location.reload();
                    } else {
                        const mins = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                        const secs = Math.floor((remaining % (1000 * 60)) / 1000);
                        document.getElementById('lock-timer').textContent = 
                            `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                    }
                }, 1000);
            } else {
                // Tempo expirou, limpa o bloqueio
                localStorage.removeItem(STORAGE_KEY);
            }
        }
    }

    function setSessionLock() {
        const sessionData = {
            timestamp: Date.now(),
            active: true
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(sessionData));
    }

    // --- FUN√á√ÉO TOAST ---
    let toastTimeout;
    function showToast(message) {
        const toast = document.getElementById("custom-toast");
        toast.textContent = message;
        toast.className = "show";
        if (toastTimeout) clearTimeout(toastTimeout);
        toastTimeout = setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 4000);
    }

    // --- FUN√á√ÉO MODAL ---
    function showModal(message, onConfirm = null, isConfirm = false) {
        const overlay = document.getElementById('custom-modal-overlay');
        const title = document.getElementById('modal-title');
        const text = document.getElementById('modal-text');
        const actions = document.getElementById('modal-actions');

        title.textContent = isConfirm ? "Confirma√ß√£o Necess√°ria" : "Aviso do Sistema";
        text.innerHTML = message.replace(/\n/g, '<br>');
        actions.innerHTML = ""; 

        const btnYes = document.createElement("button");
        btnYes.textContent = isConfirm ? "Sim, continuar" : "Entendi";
        btnYes.className = "bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded transition shadow-md";
        btnYes.onclick = () => {
            closeModal();
            if (onConfirm) onConfirm();
        };
        actions.appendChild(btnYes);

        if (isConfirm) {
            const btnNo = document.createElement("button");
            btnNo.textContent = "Cancelar";
            btnNo.className = "bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded transition shadow-sm";
            btnNo.onclick = () => closeModal();
            actions.appendChild(btnNo);
        }

        overlay.classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('custom-modal-overlay').classList.add('hidden');
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function getCorrectAnswerIndex(questionId) {
        const charCode = _k.charCodeAt(questionId);
        return charCode - 97; 
    }

    function startExam() {
        try {
            if (typeof fullQuestionBank === 'undefined' || !fullQuestionBank) {
                showToast("Erro cr√≠tico: Banco de quest√µes (questions.js) n√£o encontrado.");
                return;
            }

            const name = document.getElementById('studentName').value.trim();
            const turma = document.getElementById('studentClass').value.trim();

            if (!name || !turma) {
                showToast("Por favor, preencha Nome e Turma antes de iniciar.");
                return;
            }

            showModal("Voc√™ tem certeza que deseja iniciar?\n\nO tempo come√ßar√° a contar e clicar fora da prova gerar√° penalidade.\n\nATEN√á√ÉO: Ao iniciar, voc√™ n√£o poder√° reiniciar a p√°gina por 1 hora.", () => {
                
                // Grava o bloqueio no navegador
                setSessionLock();

                document.getElementById('student-display').textContent = `Aluno: ${name} (${turma})`;
                document.getElementById('welcome-screen').classList.add('hidden');
                document.getElementById('exam-screen').classList.remove('hidden');
                document.getElementById('exam-screen').classList.add('block');

                isExamStarted = true;
                generateQuiz();
                startTimer();
                window.scrollTo(0, 0);
            }, true);

        } catch (e) {
            showToast("Erro ao iniciar: " + e.message);
        }
    }

    function generateQuiz() {
        const container = document.getElementById('quiz-container');
        container.innerHTML = '';
        userAnswers = {};

        const shuffled = shuffleArray([...fullQuestionBank]);
        currentQuestions = shuffled.slice(0, 20);

        currentQuestions.forEach((qObj, index) => {
            const div = document.createElement('div');
            div.className = 'bg-white p-6 rounded-lg border shadow-sm mb-4 question-card';
            
            let opts = '';
            qObj.options.forEach((opt, i) => {
                const safeOpt = opt.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                opts += `
                    <label class="flex items-center space-x-3 p-2 rounded hover:bg-blue-50 cursor-pointer">
                        <input type="radio" name="q${index}" value="${i}" class="h-5 w-5 text-blue-600" onchange="saveAnswer(${index}, ${i})">
                        <span class="text-gray-700">${safeOpt}</span>
                    </label>
                `;
            });

            div.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-800 mb-3">${index + 1}. ${qObj.q}</h3>
                <div class="space-y-2">${opts}</div>
                <div id="feedback-${index}" class="mt-2 font-bold hidden"></div>
            `;
            container.appendChild(div);
        });
    }

    function saveAnswer(idx, val) {
        userAnswers[idx] = val;
    }

    function startTimer() {
        const display = document.getElementById('timer-display');
        timerInterval = setInterval(() => {
            if (isLocked) return clearInterval(timerInterval);
            timeElapsed++;
            
            const m = Math.floor(timeElapsed / 60).toString().padStart(2, '0');
            const s = (timeElapsed % 60).toString().padStart(2, '0');
            display.textContent = `${m}:${s}`;

            if (timeElapsed >= TIME_LIMIT_SECONDS) lockQuiz("Tempo esgotado!");
        }, 1000);
    }

    function addPenalty(reason) {
        if (!isExamStarted || isLocked || document.getElementById('btn-finish').classList.contains('hidden')) return;
        
        penaltyCount++;
        document.getElementById('penalty-display').textContent = penaltyCount;
        
        const box = document.getElementById('penalty-box');
        box.classList.add('penalty-shake');
        setTimeout(() => box.classList.remove('penalty-shake'), 500);

        if (penaltyCount >= MAX_PENALTIES) lockQuiz("Muitas penalidades detectadas!");
        else showToast(`‚ö†Ô∏è PENALIDADE (${penaltyCount}/${MAX_PENALTIES}): ${reason}`);
    }

    function lockQuiz(msg) {
        isLocked = true;
        clearInterval(timerInterval);
        document.querySelectorAll('input').forEach(i => i.disabled = true);
        showModal(`${msg}\n\nO formul√°rio foi bloqueado. Finalize agora para gerar seu comprovante.`);
    }

    // --- DETECTORES DE FRAUDE ---
    document.addEventListener("visibilitychange", () => { 
        if(document.hidden && isExamStarted && !isLocked) addPenalty("Saiu da aba."); 
    });
    
    // Alerta de sa√≠da (Refresh Acidental)
    window.onbeforeunload = function() {
        if (isExamStarted && !document.getElementById('btn-finish').classList.contains('hidden')) {
            return "Se voc√™ recarregar a p√°gina, perder√° o acesso √† prova por 1 hora. Tem certeza?";
        }
    };

    window.addEventListener("blur", () => {
        const modalOpen = !document.getElementById('custom-modal-overlay').classList.contains('hidden');
        if(isExamStarted && !isLocked && !document.getElementById('btn-finish').classList.contains('hidden') && !modalOpen) {
            addPenalty("Janela perdeu o foco (clicou fora).");
        }
    });

    document.addEventListener('copy', (e) => { if(isExamStarted) { e.preventDefault(); addPenalty("C√≥pia bloqueada."); } });
    document.addEventListener('contextmenu', (e) => { e.preventDefault(); return false; });
    document.addEventListener('keydown', (e) => {
        if(e.key == "F12" || (e.ctrlKey && (e.key == "u" || e.key == "s" || e.key == "p"))) {
            e.preventDefault();
            if(isExamStarted) addPenalty("Tecla proibida.");
        }
    });

    setInterval(() => {
        if (isExamStarted && !isLocked) {
            const t0 = Date.now();
            debugger;
            if (Date.now() - t0 > 100) addPenalty("Inspector aberto.");
        }
    }, 4000);

    function finishQuiz() {
        const executeFinish = () => {
            isLocked = true;
            clearInterval(timerInterval);
            let score = 0;

            currentQuestions.forEach((q, i) => {
                const correct = getCorrectAnswerIndex(q.id);
                const feedback = document.getElementById(`feedback-${i}`);
                feedback.classList.remove('hidden');

                document.getElementsByName(`q${i}`).forEach(inp => inp.disabled = true);

                if (userAnswers[i] === correct) {
                    score += 5;
                    feedback.innerHTML = "<span class='text-green-600'>‚úÖ Correto</span>";
                    if(userAnswers[i] !== undefined) 
                        document.querySelector(`input[name="q${i}"][value="${userAnswers[i]}"]`).parentElement.classList.add('bg-green-100');
                } else {
                    feedback.innerHTML = "<span class='text-red-600'>‚ùå Incorreto</span>";
                    if(userAnswers[i] !== undefined)
                        document.querySelector(`input[name="q${i}"][value="${userAnswers[i]}"]`).parentElement.classList.add('bg-red-100');
                }
            });

            document.getElementById('score-display').textContent = score;
            document.getElementById('result-area').classList.remove('hidden');
            document.getElementById('btn-finish').classList.add('hidden');
            document.getElementById('btn-pdf').classList.remove('hidden');
            document.getElementById('result-area').scrollIntoView({ behavior: 'smooth' });
            
            // Remove o aviso de sa√≠da e o bloqueio de sess√£o ao terminar com sucesso
            window.onbeforeunload = null;
            localStorage.removeItem(STORAGE_KEY); 
        };

        if (!isLocked && Object.keys(userAnswers).length < 20) {
            showModal("Ainda existem quest√µes em branco.\nTem certeza que deseja finalizar agora?", () => {
                executeFinish();
            }, true);
        } else {
            executeFinish();
        }
    }

    async function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const name = document.getElementById('studentName').value;
        const turma = document.getElementById('studentClass').value;
        const score = document.getElementById('score-display').textContent;
        const now = new Date();
        const authString = `${name}-${score}-${timeElapsed}-${penaltyCount}-${now.getTime()}`;

        let hash = 0;
        for (let i = 0; i < authString.length; i++) {
            hash = ((hash << 5) - hash) + authString.charCodeAt(i);
            hash |= 0;
        }
        const authCode = "AUTH-" + Math.abs(hash).toString(16).toUpperCase().padStart(8, '0');

        doc.setFillColor(37, 99, 235);
        doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(20);
        doc.text("Comprovante de Avalia√ß√£o", 105, 25, null, null, "center");
        
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(12);
        doc.text(`Aluno: ${name}`, 20, 60);
        doc.text(`Turma: ${turma}`, 20, 70);
        doc.text(`Data: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`, 20, 80);
        
        doc.setFontSize(14);
        doc.text(`Nota Final: ${score}/100`, 20, 100);
        doc.text(`Tempo: ${document.getElementById('timer-display').textContent}`, 120, 100);
        
        if(penaltyCount > 0) {
            doc.setTextColor(200, 0, 0);
            doc.text(`Penalidades: ${penaltyCount}`, 20, 115);
        } else {
            doc.setTextColor(0, 128, 0);
            doc.text("Conduta: Limpa (Sem penalidades)", 20, 115);
        }

        doc.setTextColor(100, 100, 100);
        doc.setFontSize(10);
        doc.text("C√≥digo de Autentica√ß√£o:", 105, 140, null, null, "center");
        doc.setFont("courier", "bold");
        doc.setFontSize(14);
        doc.text(authCode, 105, 150, null, null, "center");

        doc.save(`Relatorio_${name.replace(/\s+/g, '_')}.pdf`);
    }
</script>
</body>
</html>
